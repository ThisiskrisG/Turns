
<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Group: {{ group.name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<link  href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>
<style>
#crop-modal {
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.6);
  align-items: center; justify-content: center;
  z-index: 1050;
  overflow-y: auto;
  padding: 1rem;
}
#crop-box {
  background: #fff;
  padding: 1rem;
  border-radius: 8px;
  text-align: center;
  max-width: 95vw;
  width: 100%;
  box-sizing: border-box;
}
#crop-image {
  width: 100%;
  height: auto;
  max-height: 60vh;
}
</style>

</head>
<body>
<div class="container mt-4">
  <h3>{{ group.name }} Chat Room</h3>


{% if group.created_by == session['user_id'] %}
<form action="{{ url_for('edit_group_avatar', group_id=group.id) }}" method="POST" enctype="multipart/form-data" class="mb-3">
  <label for="avatar" class="form-label">Update Group Icon</label>
  <input type="file" name="avatar" id="avatar-input" class="form-control mb-2" accept="image/*" required>
  <img id="avatar-preview" src="{{ url_for('static', filename='group_icons/' + (group.avatar or 'default_group.png')) }}" width="100" class="rounded-circle mb-2" style="object-fit: cover;">
  <button class="btn btn-outline-primary">Update Avatar</button>
</form>
<script>
document.getElementById('avatar-input').addEventListener('change', function(event) {
  const [file] = event.target.files;
  if (file) {
    document.getElementById('avatar-preview').src = URL.createObjectURL(file);
  }
});

<script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
<script>
let cropper;
const avatarInput = document.getElementById("avatar-input");
const cropModal = document.getElementById("crop-modal");
const cropImage = document.getElementById("crop-image");

avatarInput.addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    cropImage.src = e.target.result;
    cropModal.style.display = "flex";
    if (cropper) cropper.destroy();
    cropper = new Cropper(cropImage, {
      aspectRatio: 1,
      viewMode: 1
    });
  };
  reader.readAsDataURL(file);
});

function closeCrop() {
  cropModal.style.display = "none";
  if (cropper) cropper.destroy();
  cropper = null;
  avatarInput.value = "";
}

function applyCrop() {
  cropper.getCroppedCanvas({ width: 100, height: 100 }).toBlob(function(blob) {
    const formData = new FormData();
    formData.append('avatar', blob, 'cropped.png');

    fetch('{{ url_for('edit_group_avatar', group_id=group.id) }}', {
      method: 'POST',
      body: formData
    }).then(() => location.reload());
  }, 'image/png');
}
</script>

</script>
{% endif %}
{% endif %}

  <p><strong>Members:</strong> {% for m in members %}{{ m.username }}{% if not loop.last %}, {% endif %}{% endfor %}</p>
  <div class="border p-3 mb-3" style="max-height: 300px; overflow-y: auto;" id="chat-box">
    {% for msg in messages %}
      <div class="mb-2">
        <strong>User {{ msg.sender_id }}:</strong> {{ msg.content }}
        <small class="text-muted d-block">{{ msg.timestamp }}</small>
      </div>
    {% endfor %}
  </div>
  <form id="group-form" onsubmit="sendMessage(); return false;">
    <textarea class="form-control mb-2" id="msg-input" rows="2" required></textarea>
    <button class="btn btn-success">Send</button>
  </form>
</div>

<audio id="notif-sound-group" src="/static/sounds/group.mp3" preload="auto"></audio>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js">
<script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
<script>
let cropper;
const avatarInput = document.getElementById("avatar-input");
const cropModal = document.getElementById("crop-modal");
const cropImage = document.getElementById("crop-image");

avatarInput.addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    cropImage.src = e.target.result;
    cropModal.style.display = "flex";
    if (cropper) cropper.destroy();
    cropper = new Cropper(cropImage, {
      aspectRatio: 1,
      viewMode: 1
    });
  };
  reader.readAsDataURL(file);
});

function closeCrop() {
  cropModal.style.display = "none";
  if (cropper) cropper.destroy();
  cropper = null;
  avatarInput.value = "";
}

function applyCrop() {
  cropper.getCroppedCanvas({ width: 100, height: 100 }).toBlob(function(blob) {
    const formData = new FormData();
    formData.append('avatar', blob, 'cropped.png');

    fetch('{{ url_for('edit_group_avatar', group_id=group.id) }}', {
      method: 'POST',
      body: formData
    }).then(() => location.reload());
  }, 'image/png');
}
</script>

</script>
<script>
const socket = io();
const groupId = {{ group.id }};
const userId = {{ session['user_id'] }};
socket.emit('join', { user_id: userId, group_id: groupId });

function sendMessage() {
  const content = document.getElementById("msg-input").value.trim();
  if (!content) return;
  socket.emit("group_message", {
    group_id: groupId,
    sender_id: userId,
    content: content
  });
  document.getElementById("msg-input").value = "";
}

socket.on("group_broadcast", function(data) {
  if (data.group_id != groupId) return;
  const box = document.getElementById("chat-box");
  const msg = document.createElement("div");
  msg.classList.add("mb-2");
  msg.innerHTML = `<strong>User ${data.sender_id}:</strong> ${data.content}<br><small class='text-muted'>Just now</small>`;
  box.appendChild(msg);
  box.scrollTop = box.scrollHeight;

  if (document.hidden && Notification.permission === "granted") {
    new Notification("Group: {{ group.name }}", { body: data.content });
    document.getElementById("notif-sound-group").play();
  }
});

if (Notification.permission !== "granted") {
  Notification.requestPermission();
}

<script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
<script>
let cropper;
const avatarInput = document.getElementById("avatar-input");
const cropModal = document.getElementById("crop-modal");
const cropImage = document.getElementById("crop-image");

avatarInput.addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    cropImage.src = e.target.result;
    cropModal.style.display = "flex";
    if (cropper) cropper.destroy();
    cropper = new Cropper(cropImage, {
      aspectRatio: 1,
      viewMode: 1
    });
  };
  reader.readAsDataURL(file);
});

function closeCrop() {
  cropModal.style.display = "none";
  if (cropper) cropper.destroy();
  cropper = null;
  avatarInput.value = "";
}

function applyCrop() {
  cropper.getCroppedCanvas({ width: 100, height: 100 }).toBlob(function(blob) {
    const formData = new FormData();
    formData.append('avatar', blob, 'cropped.png');

    fetch('{{ url_for('edit_group_avatar', group_id=group.id) }}', {
      method: 'POST',
      body: formData
    }).then(() => location.reload());
  }, 'image/png');
}
</script>

</script>

<!-- Crop Modal -->
<div id="crop-modal" class="d-flex">
  <div id="crop-box">
    <h5 class="mb-3">Crop Group Icon</h5>
    <img id="crop-image" src="#" alt="Preview">
    <div class="mt-3">
      <button type="button" class="btn btn-secondary me-2" onclick="closeCrop()">Cancel</button>
      <button type="button" class="btn btn-primary" onclick="applyCrop()">Crop & Upload</button>
    </div>
  </div>
</div>

</body>
</html>
