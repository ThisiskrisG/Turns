
<!DOCTYPE html>
<html>
<head>
    <title>Messages</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
  <h3>Chat with {{ user.username }}</h3>
  <div class="border p-3 mb-3" style="max-height: 300px; overflow-y: auto;">
    {% for msg in chat %}
      <div class="mb-2">
        <strong>{{ 'You' if msg.sender_id == session['user_id'] else user.username }}:</strong>
        {{ msg.content }}
        <small class="text-muted d-block">{{ msg.timestamp }}</small>
      </div>
    {% else %}
      <p>No messages yet.</p>
    {% endfor %}
  </div>
  <form method="POST">
    <textarea class="form-control mb-2" name="content" rows="2" required></textarea>
    <button class="btn btn-primary">Send</button>
  </form>
</div>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
const socket = io();
socket.emit('join', { user_id: {{ session['user_id'] }} });

if (Notification.permission !== "granted") {
  Notification.requestPermission();
}


socket.on('new_message', function(data) {
  if (data.sender_id == {{ user.id }} && data.recipient_id == {{ session['user_id'] }}) {
    const container = document.querySelector('.border');
    const msg = document.createElement('div');
    msg.classList.add('mb-2');
    msg.innerHTML = `<strong>{{ user.username }}:</strong> ` + data.content + `<br><small class='text-muted'>Just now</small>`;
    container.appendChild(msg);

    if (document.hidden && Notification.permission === "granted") {
      new Notification("New message from {{ user.username }}", {
        body: data.content,
        icon: "/static/images/{{ user.photo }}"
      });

      const soundType = data.is_group ? "notif-sound-group" : "notif-sound-dm";
      document.getElementById(soundType).play();
    }
  }
});

</script>

<audio id="notif-sound" src="/static/sounds/notify.mp3" preload="auto"></audio>

</body>
</html>
